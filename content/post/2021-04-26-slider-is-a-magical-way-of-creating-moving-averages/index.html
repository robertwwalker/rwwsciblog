---
title: slider is a magical way of creating moving averages
author: RWW
date: '2021-04-26'
slug: []
categories:
  - R
  - tidyverse
  - time series
tags:
  - time series
  - R
  - tidyverse
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<div id="nikes-stock" class="section level2">
<h2>Nike’s Stock</h2>
<pre class="r"><code># Load libraries
library(tidyquant)</code></pre>
<pre><code>## Loading required package: lubridate</code></pre>
<pre><code>## 
## Attaching package: &#39;lubridate&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     date, intersect, setdiff, union</code></pre>
<pre><code>## Loading required package: PerformanceAnalytics</code></pre>
<pre><code>## Loading required package: xts</code></pre>
<pre><code>## Loading required package: zoo</code></pre>
<pre><code>## 
## Attaching package: &#39;zoo&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     as.Date, as.Date.numeric</code></pre>
<pre><code>## 
## Attaching package: &#39;PerformanceAnalytics&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:graphics&#39;:
## 
##     legend</code></pre>
<pre><code>## Loading required package: quantmod</code></pre>
<pre><code>## Loading required package: TTR</code></pre>
<pre><code>## Registered S3 method overwritten by &#39;quantmod&#39;:
##   method            from
##   as.zoo.data.frame zoo</code></pre>
<pre><code>## ══ Need to Learn tidyquant? ════════════════════════════════════════════════════
## Business Science offers a 1-hour course - Learning Lab #9: Performance Analysis &amp; Portfolio Optimization with tidyquant!
## &lt;/&gt; Learn more at: https://university.business-science.io/p/learning-labs-pro &lt;/&gt;</code></pre>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──</code></pre>
<pre><code>## ✓ ggplot2 3.3.3     ✓ purrr   0.3.4
## ✓ tibble  3.1.1     ✓ dplyr   1.0.5
## ✓ tidyr   1.1.3     ✓ stringr 1.4.0
## ✓ readr   1.4.0     ✓ forcats 0.5.1</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## x lubridate::as.difftime() masks base::as.difftime()
## x lubridate::date()        masks base::date()
## x dplyr::filter()          masks stats::filter()
## x dplyr::first()           masks xts::first()
## x lubridate::intersect()   masks base::intersect()
## x dplyr::lag()             masks stats::lag()
## x dplyr::last()            masks xts::last()
## x lubridate::setdiff()     masks base::setdiff()
## x lubridate::union()       masks base::union()</code></pre>
<pre class="r"><code>library(fpp3)</code></pre>
<pre><code>## ── Attaching packages ──────────────────────────────────────────── fpp3 0.4.0 ──</code></pre>
<pre><code>## ✓ tsibble     1.0.1     ✓ feasts      0.2.1
## ✓ tsibbledata 0.3.0     ✓ fable       0.3.0</code></pre>
<pre><code>## ── Conflicts ───────────────────────────────────────────────── fpp3_conflicts ──
## x lubridate::date()    masks base::date()
## x dplyr::filter()      masks stats::filter()
## x dplyr::first()       masks xts::first()
## x tsibble::index()     masks zoo::index()
## x tsibble::intersect() masks base::intersect()
## x tsibble::interval()  masks lubridate::interval()
## x dplyr::lag()         masks stats::lag()
## x dplyr::last()        masks xts::last()
## x tsibble::setdiff()   masks base::setdiff()
## x tsibble::union()     masks base::union()
## x fable::VAR()         masks tidyquant::VAR()</code></pre>
<pre><code>## 
## Attaching package: &#39;fpp3&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:PerformanceAnalytics&#39;:
## 
##     prices</code></pre>
<p>With those libraries, I should have what I need. Let me get Nike’s stock from 2015.</p>
<pre class="r"><code># Get Nike stock data
Nike.Stocks &lt;- tq_get(&quot;NKE&quot;, from=&quot;2015-01-01&quot;)</code></pre>
<p>Now I want to create monthly data. I will the <code>yearmonth</code> type from lubridate. By default, <code>tidyquant</code> uses <code>yearmon</code> which is different.</p>
<pre class="r"><code># Create nike returns, need tq_transmute because we are taking daily data and turning it into monthly.
Nike.Returns &lt;- Nike.Stocks %&gt;% tq_transmute(adjusted, mutate_fun=periodReturn, period=&quot;monthly&quot;) 
Nike.Returns # It is monthly but the date is a date.  To make them match, I need a yearmonth</code></pre>
<pre><code>## # A tibble: 76 x 2
##    date       monthly.returns
##    &lt;date&gt;               &lt;dbl&gt;
##  1 2015-01-30         -0.0293
##  2 2015-02-27          0.0558
##  3 2015-03-31          0.0331
##  4 2015-04-30         -0.0149
##  5 2015-05-29          0.0314
##  6 2015-06-30          0.0625
##  7 2015-07-31          0.0667
##  8 2015-08-31         -0.0301
##  9 2015-09-30          0.103 
## 10 2015-10-30          0.0655
## # … with 66 more rows</code></pre>
<p>I want to mutate the <code>date</code> to be a <code>yearmonth</code>. Getting the time measure right is the crucial part of this.</p>
<pre class="r"><code>Nike.Returns &lt;- Nike.Returns %&gt;% mutate(date = yearmonth(date))
Nike.Returns</code></pre>
<pre><code>## # A tibble: 76 x 2
##        date monthly.returns
##       &lt;mth&gt;           &lt;dbl&gt;
##  1 2015 Jan         -0.0293
##  2 2015 Feb          0.0558
##  3 2015 Mar          0.0331
##  4 2015 Apr         -0.0149
##  5 2015 May          0.0314
##  6 2015 Jun          0.0625
##  7 2015 Jul          0.0667
##  8 2015 Aug         -0.0301
##  9 2015 Sep          0.103 
## 10 2015 Oct          0.0655
## # … with 66 more rows</code></pre>
<p>Now let me try another mutation. Let me keep the last closing price of the month. The last step here makes sure the dates are the same type. All of this remains <code>tibble</code> as the type; not <code>tsibble</code>. That is convenient for joining data.</p>
<pre class="r"><code>Nike.Last &lt;- Nike.Stocks %&gt;% 
  tq_transmute(select = adjusted, mutate_fun = to.monthly) %&gt;%
  mutate(date = yearmonth(date))
Nike.Last</code></pre>
<pre><code>## # A tibble: 76 x 2
##        date adjusted
##       &lt;mth&gt;    &lt;dbl&gt;
##  1 2015 Jan     43.0
##  2 2015 Feb     45.5
##  3 2015 Mar     47.0
##  4 2015 Apr     46.3
##  5 2015 May     47.7
##  6 2015 Jun     50.7
##  7 2015 Jul     54.1
##  8 2015 Aug     52.4
##  9 2015 Sep     57.9
## 10 2015 Oct     61.6
## # … with 66 more rows</code></pre>
<p>The dates match up, so they should join up nicely. Let’s try that.</p>
<pre class="r"><code>Nike.Data &lt;- Nike.Returns %&gt;% left_join(., Nike.Last, by = c(&quot;date&quot; = &quot;date&quot;))
# Turn it into a tsibble.  That means defining the yearmonth as the data and indexing a tsibble by that.
Nike.Data &lt;- Nike.Data  %&gt;% mutate(date = yearmonth(date)) %&gt;% as_tsibble(index=date)</code></pre>
<p>Now it is a <code>tsibble</code> to work with in the <code>fpp3</code> workflow. Finally, let’s set up training and test sets. Working with the Nike data; use filter_index to grab all the data up to and including January 2020</p>
<pre class="r"><code>Nike.Data.Train &lt;- Nike.Data  %&gt;% filter_index(. ~ &quot;2020-01&quot;)
# Look at it.
Nike.Data.Train %&gt;% tail()</code></pre>
<pre><code>## # A tsibble: 6 x 3 [1M]
##       date monthly.returns adjusted
##      &lt;mth&gt;           &lt;dbl&gt;    &lt;dbl&gt;
## 1 2019 Aug         -0.0152     83.3
## 2 2019 Sep          0.111      92.6
## 3 2019 Oct         -0.0465     88.3
## 4 2019 Nov          0.0467     92.4
## 5 2019 Dec          0.0836    100. 
## 6 2020 Jan         -0.0495     95.2</code></pre>
<pre class="r"><code># Create a test set as everything that is not in the training set, e.g. the last 15 months
Nike.Data.Test &lt;- anti_join(Nike.Data,Nike.Data.Train) %&gt;% as_tsibble(index=date)</code></pre>
<pre><code>## Joining, by = c(&quot;date&quot;, &quot;monthly.returns&quot;, &quot;adjusted&quot;)</code></pre>
</div>
<div id="three-month-trailing-averages" class="section level2">
<h2>Three-month trailing averages</h2>
<pre class="r"><code>NMA &lt;- Nike.Data %&gt;% mutate(MMR3 = slider::slide_dbl(monthly.returns, mean, .before=3, .after=0), MMR6 = slider::slide_dbl(monthly.returns, mean, .before=6, .after=0)) 
NMA %&gt;% autoplot(MMR3) + autolayer(NMA %&gt;% select(MMR6), color=&quot;red&quot;) + labs(x=&quot;Month&quot;, y=&quot;Monthly Returns of Nike&quot;, title=&quot;Monthly Returns of Nike&quot;, subtitle=&quot;3 and 6 month trailing averages [red]&quot;)</code></pre>
<pre><code>## Plot variable not specified, automatically selected `.vars = MMR6`</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
